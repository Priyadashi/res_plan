<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Hub Resource Planning Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #6366f1;
            --primary-dark: #4338ca;
            --success: #059669;
            --success-light: #10b981;
            --warning: #d97706;
            --warning-light: #f59e0b;
            --danger: #dc2626;
            --danger-light: #ef4444;
            --info: #0284c7;
            --bg-page: #f8fafc;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            --bg-input: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border: #e2e8f0;
            --border-light: #f1f5f9;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-page);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .header {
            background: var(--bg-card);
            padding: 0.75rem 2rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: white;
        }

        .logo-text {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #047857; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-outline:hover { background: var(--bg-hover); border-color: var(--text-muted); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #b91c1c; }
        .btn-info { background: var(--info); color: white; }
        .btn-info:hover { background: #0369a1; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-warning:hover { background: #b45309; }
        .btn-sm { padding: 0.35rem 0.6rem; font-size: 0.75rem; }

        .tabs {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
        }

        .tabs-list {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            gap: 0;
        }

        .tab-btn {
            padding: 0.875rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab-btn:hover { color: var(--text-secondary); }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .main-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem 2rem;
        }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .card {
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            margin-bottom: 1.25rem;
        }

        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); }
        .card-subtitle { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.125rem; }
        .card-body { padding: 1.25rem; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .data-table th {
            background: var(--bg-page);
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.625rem 0.75rem;
            text-align: left;
            border-bottom: 2px solid var(--border);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table td {
            padding: 0.625rem 0.75rem;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }

        .data-table tr:hover { background: var(--bg-hover); }

        .data-table input, .data-table select {
            width: 100%;
            padding: 0.375rem 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.8rem;
            background: white;
        }

        .data-table input:focus, .data-table select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }

        .data-table input[type="number"] { width: 70px; }

        .allocation-grid { display: grid; gap: 0.75rem; }

        .allocation-row {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.875rem;
            display: grid;
            grid-template-columns: 1fr 1fr 120px 80px 140px auto;
            gap: 0.75rem;
            align-items: center;
        }

        .allocation-row select, .allocation-row input {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 1.25rem;
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }

        .metric-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .metric-card.primary .metric-icon { background: #eef2ff; }
        .metric-card.success .metric-icon { background: #ecfdf5; }
        .metric-card.info .metric-icon { background: #f0f9ff; }
        .metric-card.warning .metric-icon { background: #fffbeb; }
        .metric-card.danger .metric-icon { background: #fef2f2; }

        .metric-value { font-size: 1.75rem; font-weight: 700; line-height: 1; margin-bottom: 0.25rem; }

        .metric-card.primary .metric-value { color: var(--primary); }
        .metric-card.success .metric-value { color: var(--success); }
        .metric-card.info .metric-value { color: var(--info); }
        .metric-card.warning .metric-value { color: var(--warning); }
        .metric-card.danger .metric-value { color: var(--danger); }

        .metric-label { color: var(--text-secondary); font-size: 0.75rem; font-weight: 500; }
        .metric-subtitle { font-size: 0.65rem; color: var(--text-muted); margin-top: 0.2rem; }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
            margin-bottom: 1.25rem;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 1rem;
            border: 1px solid var(--border);
        }

        .chart-card.full-width { grid-column: 1 / -1; }
        .chart-header { margin-bottom: 0.75rem; }
        .chart-title { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); }
        .chart-subtitle { font-size: 0.7rem; color: var(--text-muted); }
        .chart-container { height: 260px; position: relative; }

        .heatmap-container { overflow-x: auto; }

        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .heatmap-table th, .heatmap-table td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid var(--border);
        }

        .heatmap-table th {
            background: var(--bg-page);
            font-weight: 600;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .heatmap-table td:first-child, .heatmap-table th:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--bg-card);
            font-weight: 500;
        }

        .heatmap-cell {
            border-radius: 4px;
            padding: 0.4rem 0.3rem;
            font-weight: 600;
            min-width: 55px;
            font-size: 0.75rem;
        }

        .heatmap-available { background: #f1f5f9; color: #64748b; }
        .heatmap-low { background: #fee2e2; color: #991b1b; }
        .heatmap-medium { background: #fef3c7; color: #92400e; }
        .heatmap-optimal { background: #dcfce7; color: #166534; }
        .heatmap-high { background: #dbeafe; color: #1e40af; }
        .heatmap-overload { background: #dc2626; color: white; }

        .legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .legend-color { width: 12px; height: 12px; border-radius: 3px; }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
        .empty-state h3 { font-size: 1rem; color: var(--text-secondary); margin-bottom: 0.35rem; }
        .empty-state p { font-size: 0.85rem; margin-bottom: 1rem; }

        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: var(--text-primary);
            color: white;
            padding: 0.875rem 1.25rem;
            border-radius: 8px;
            font-size: 0.85rem;
            box-shadow: var(--shadow-md);
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .toast.show { display: block; }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .filters-bar {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-select {
            padding: 0.4rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
            background: white;
            min-width: 140px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        /* ===== MODAL STYLES ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 500;
            justify-content: center;
            align-items: flex-start;
            padding: 2rem;
            overflow-y: auto;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 520px;
            animation: modalIn 0.25s ease;
        }
        .modal.modal-wide { max-width: 900px; }

        @keyframes modalIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { font-size: 1rem; font-weight: 600; }

        .modal-body { padding: 1.25rem; }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .modal-close {
            background: none; border: none; cursor: pointer;
            font-size: 1.25rem; color: var(--text-muted);
            padding: 0.25rem; line-height: 1;
        }
        .modal-close:hover { color: var(--text-primary); }

        .form-group {
            margin-bottom: 0.875rem;
        }
        .form-group label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            background: white;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
        }

        /* Skill / Level tag management */
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 0.75rem;
        }
        .tag-item {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            background: #eef2ff;
            color: var(--primary);
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .tag-item .tag-remove {
            background: none; border: none; cursor: pointer;
            color: var(--danger); font-size: 0.85rem; line-height: 1;
            padding: 0; margin-left: 0.15rem;
        }
        .tag-item .tag-remove:hover { color: #b91c1c; }

        .add-tag-row {
            display: flex;
            gap: 0.4rem;
        }
        .add-tag-row input {
            flex: 1;
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
        }

        /* Positions table in project modal */
        .positions-section {
            margin-top: 1rem;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
        }
        .positions-section h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        .positions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.78rem;
        }
        .positions-table th {
            background: var(--bg-page);
            color: var(--text-secondary);
            font-weight: 600;
            padding: 0.5rem 0.5rem;
            text-align: left;
            border-bottom: 2px solid var(--border);
            font-size: 0.68rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .positions-table td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid var(--border-light);
            vertical-align: middle;
        }
        .positions-table input,
        .positions-table select {
            width: 100%;
            padding: 0.35rem 0.45rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.78rem;
            background: white;
        }
        .positions-table input:focus,
        .positions-table select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1);
        }
        .positions-table input[type="number"] { width: 65px; }
        .positions-table input[type="date"] { width: 130px; }

        /* Project card expand/positions view */
        .project-positions-row td {
            padding: 0;
            background: var(--bg-page);
        }
        .project-positions-inner {
            padding: 0.75rem 1rem;
        }
        .project-positions-inner h5 {
            font-size: 0.78rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        .pos-mini-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }
        .pos-mini-table th {
            background: var(--bg-card);
            color: var(--text-muted);
            font-weight: 600;
            padding: 0.4rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.65rem;
            text-transform: uppercase;
        }
        .pos-mini-table td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid var(--border-light);
        }
        .pos-mini-table select,
        .pos-mini-table input {
            width: 100%;
            padding: 0.3rem 0.4rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.75rem;
            background: white;
        }
        .pos-mini-table input[type="number"] { width: 60px; }
        .pos-mini-table input[type="date"] { width: 125px; }

        .btn-expand {
            background: none; border: none; cursor: pointer;
            font-size: 0.9rem; color: var(--text-muted);
            padding: 0.2rem 0.4rem; border-radius: 4px;
            transition: all 0.15s;
        }
        .btn-expand:hover { background: var(--bg-hover); color: var(--text-primary); }

        .header-btn-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        @media (max-width: 1200px) {
            .charts-row { grid-template-columns: 1fr; }
            .metrics-grid { grid-template-columns: repeat(3, 1fr); }
            .allocation-row { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 768px) {
            .metrics-grid { grid-template-columns: repeat(2, 1fr); }
            .header-content { flex-direction: column; gap: 0.75rem; }
            .tabs-list { overflow-x: auto; }
            .form-row { grid-template-columns: 1fr; }
            .form-row-3 { grid-template-columns: 1fr; }
        }

        @media print {
            .header, .tabs, .filters-bar, .btn { display: none !important; }
            .tab-panel { display: block !important; }
            #tab-resources, #tab-projects, #tab-allocations { display: none !important; }
            #tab-dashboard { display: block !important; }
            .main-content { padding: 0; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üìä</div>
                <div class="logo-text">ERP Hub Resource Planning</div>
            </div>
            <div class="header-actions">
                <button class="btn btn-outline" onclick="importData()">üì• Import</button>
                <button class="btn btn-success" onclick="saveFile()">üíæ Save File</button>
            </div>
        </div>
    </header>

    <nav class="tabs">
        <div class="tabs-list">
            <button class="tab-btn active" data-tab="resources">üë• Resources</button>
            <button class="tab-btn" data-tab="projects">üìÅ Projects</button>
            <button class="tab-btn" data-tab="dashboard">üìä Dashboard</button>
        </div>
    </nav>

    <main class="main-content">
        <!-- RESOURCES TAB -->
        <div id="tab-resources" class="tab-panel active">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Team Resources</div>
                        <div class="card-subtitle">Manage your team members and their skills</div>
                    </div>
                    <div class="header-btn-group">
                        <button class="btn btn-outline btn-sm" onclick="openManageSkillsModal()">‚öô Manage Skills</button>
                        <button class="btn btn-outline btn-sm" onclick="openManageLevelsModal()">‚öô Manage Levels</button>
                        <button class="btn btn-primary btn-sm" onclick="addResource()">+ Add Resource</button>
                    </div>
                </div>
                <div class="card-body">
                    <table class="data-table" id="resourcesTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Primary Skill</th>
                                <th>Secondary Skill</th>
                                <th>Resource Level</th>
                                <th>Status</th>
                                <th>Hours/Week</th>
                                <th>Cost Rate ($/hr)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="resourcesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- PROJECTS TAB -->
        <div id="tab-projects" class="tab-panel">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Projects Portfolio</div>
                        <div class="card-subtitle">Active and planned projects in your pipeline</div>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="openAddProjectModal()">+ Add Project</button>
                </div>
                <div class="card-body">
                    <table class="data-table" id="projectsTable">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Project Name</th>
                                <th>Client</th>
                                <th>Type</th>
                                <th>Probability %</th>
                                <th>Priority</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Required FTE</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="projectsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-panel">
            <div class="dashboard-header">
                <div class="filters-bar" style="margin-bottom: 0;">
                    <select class="filter-select" id="dashFilterSkill" onchange="renderDashboard()"><option value="">All Skills</option></select>
                    <select class="filter-select" id="dashFilterType" onchange="renderDashboard()">
                        <option value="">All Types</option>
                        <option value="Active">Active</option>
                        <option value="Planned">Planned</option>
                    </select>
                    <button class="btn btn-outline btn-sm" onclick="resetDashFilters()">Reset</button>
                </div>
                <button class="btn btn-info" onclick="exportPDF()">üìÑ Export PDF</button>
            </div>

            <div id="dashboardContent">
                <section class="metrics-grid">
                    <div class="metric-card primary">
                        <div class="metric-icon">üìÇ</div>
                        <div class="metric-value" id="metricActiveProjects">0</div>
                        <div class="metric-label">Active Projects</div>
                        <div class="metric-subtitle">Confirmed</div>
                    </div>
                    <div class="metric-card info">
                        <div class="metric-icon">üìã</div>
                        <div class="metric-value" id="metricPlannedProjects">0</div>
                        <div class="metric-label">Planned Projects</div>
                        <div class="metric-subtitle" id="metricWeightedFTE">0 weighted FTE</div>
                    </div>
                    <div class="metric-card success">
                        <div class="metric-icon">üë•</div>
                        <div class="metric-value" id="metricResources">0</div>
                        <div class="metric-label">Total Resources</div>
                        <div class="metric-subtitle" id="metricAvgUtil">0% avg util</div>
                    </div>
                    <div class="metric-card warning">
                        <div class="metric-icon">‚ö†Ô∏è</div>
                        <div class="metric-value" id="metricAvailable">0</div>
                        <div class="metric-label">Available</div>
                        <div class="metric-subtitle">Under 50%</div>
                    </div>
                    <div class="metric-card danger">
                        <div class="metric-icon">üî•</div>
                        <div class="metric-value" id="metricOverloaded">0</div>
                        <div class="metric-label">Overloaded</div>
                        <div class="metric-subtitle">Over 100%</div>
                    </div>
                </section>

                <section class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Project Pipeline</div>
                            <div class="chart-subtitle">Active and planned projects by FTE</div>
                        </div>
                        <div class="chart-container"><canvas id="pipelineChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Aggregate Utilization</div>
                            <div class="chart-subtitle">Team capacity over time</div>
                        </div>
                        <div class="chart-container"><canvas id="utilizationChart"></canvas></div>
                    </div>
                </section>

                <section class="charts-row">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Projected Revenue</div>
                            <div class="chart-subtitle">Monthly revenue forecast</div>
                        </div>
                        <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Supply vs Demand</div>
                            <div class="chart-subtitle">Capacity gap by skill</div>
                        </div>
                        <div class="chart-container"><canvas id="supplyDemandChart"></canvas></div>
                    </div>
                </section>

                <section class="charts-row">
                    <div class="chart-card full-width">
                        <div class="chart-header">
                            <div class="chart-title">Resource Utilization Heatmap</div>
                            <div class="chart-subtitle">Monthly allocation per resource</div>
                        </div>
                        <div class="heatmap-container">
                            <table class="heatmap-table" id="heatmapTable">
                                <thead><tr><th>Resource</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="legend">
                            <div class="legend-item"><div class="legend-color heatmap-available"></div><span>0%</span></div>
                            <div class="legend-item"><div class="legend-color heatmap-low"></div><span>&lt;50%</span></div>
                            <div class="legend-item"><div class="legend-color heatmap-medium"></div><span>50-70%</span></div>
                            <div class="legend-item"><div class="legend-color heatmap-optimal"></div><span>70-90%</span></div>
                            <div class="legend-item"><div class="legend-color heatmap-high"></div><span>90-100%</span></div>
                            <div class="legend-item"><div class="legend-color heatmap-overload"></div><span>&gt;100%</span></div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <div class="toast" id="toast"></div>

    <!-- MANAGE SKILLS MODAL -->
    <div class="modal-overlay" id="manageSkillsOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Manage Skills</h3>
                <button class="modal-close" onclick="closeModal('manageSkillsOverlay')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.75rem;">
                    Add or remove skills available in the Primary Skill and Secondary Skill dropdowns.
                </p>
                <div class="tag-list" id="skillTagList"></div>
                <div class="add-tag-row">
                    <input type="text" id="newSkillInput" placeholder="Enter new skill name..." onkeydown="if(event.key==='Enter')addSkillTag()">
                    <button class="btn btn-primary btn-sm" onclick="addSkillTag()">+ Add</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline btn-sm" onclick="closeModal('manageSkillsOverlay')">Close</button>
            </div>
        </div>
    </div>

    <!-- MANAGE RESOURCE LEVELS MODAL -->
    <div class="modal-overlay" id="manageLevelsOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Manage Resource Levels</h3>
                <button class="modal-close" onclick="closeModal('manageLevelsOverlay')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:0.75rem;">
                    Add or remove resource level options available in the Resource Level dropdown.
                </p>
                <div class="tag-list" id="levelTagList"></div>
                <div class="add-tag-row">
                    <input type="text" id="newLevelInput" placeholder="Enter new level name..." onkeydown="if(event.key==='Enter')addLevelTag()">
                    <button class="btn btn-primary btn-sm" onclick="addLevelTag()">+ Add</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline btn-sm" onclick="closeModal('manageLevelsOverlay')">Close</button>
            </div>
        </div>
    </div>

    <!-- ADD / EDIT PROJECT MODAL -->
    <div class="modal-overlay" id="projectModalOverlay">
        <div class="modal modal-wide">
            <div class="modal-header">
                <h3 id="projectModalTitle">Add Project</h3>
                <button class="modal-close" onclick="closeModal('projectModalOverlay')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Project Name</label>
                        <input type="text" id="pf_name" placeholder="Project name">
                    </div>
                    <div class="form-group">
                        <label>Client</label>
                        <input type="text" id="pf_client" placeholder="Client name">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="pf_type">
                            <option value="Active">Active</option>
                            <option value="Planned" selected>Planned</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Probability %</label>
                        <input type="number" id="pf_probability" value="50" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="pf_priority">
                            <option value="High">High</option>
                            <option value="Medium" selected>Medium</option>
                            <option value="Low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="pf_startDate">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="pf_endDate">
                    </div>
                    <div class="form-group">
                        <label>Required FTE</label>
                        <input type="number" id="pf_requiredFTE" value="1" min="1" step="1" onchange="updateProjectFormPositions()">
                    </div>
                </div>

                <div class="positions-section" id="projectFormPositionsSection">
                    <h4>Positions (based on Required FTE)</h4>
                    <div style="overflow-x:auto;">
                        <table class="positions-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Position</th>
                                    <th>Resource Level</th>
                                    <th>% Capacity</th>
                                    <th>Expected Start</th>
                                    <th>Expected End</th>
                                    <th>Resource Allocation</th>
                                </tr>
                            </thead>
                            <tbody id="projectFormPositionsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline btn-sm" onclick="closeModal('projectModalOverlay')">Cancel</button>
                <button class="btn btn-primary btn-sm" id="projectModalSaveBtn" onclick="saveProjectFromModal()">Save Project</button>
            </div>
        </div>
    </div>

    <script>
        // ========== DATA STORE ==========
        let data = {
            skills: ['Frontend','Backend','Full Stack','DevOps','UI/UX','QA','Data','Mobile','Cloud','Security'],
            resourceLevels: ['Junior','Mid','Senior','Lead','Principal'],
            resources: [
                {id: "R001", name: "Alice Johnson", primarySkill: "Frontend", secondarySkill: "UI/UX", resourceLevel: "Senior", status: "Active", hoursPerWeek: 40, costRate: 150},
                {id: "R002", name: "Bob Smith", primarySkill: "Backend", secondarySkill: "DevOps", resourceLevel: "Senior", status: "Active", hoursPerWeek: 40, costRate: 160},
                {id: "R003", name: "Carol Williams", primarySkill: "Full Stack", secondarySkill: "Backend", resourceLevel: "Lead", status: "Active", hoursPerWeek: 40, costRate: 175}
            ],
            projects: [
                {id: "P001", name: "E-Commerce Platform", client: "RetailCorp", type: "Active", probability: 100, priority: "High", startDate: "2025-01-15", endDate: "2025-06-30", requiredFTE: 3, positions: [
                    {posId: "POS001", position: "Lead Developer", resourceLevel: "Lead", capacity: 100, expectedStart: "2025-01-15", expectedEnd: "2025-06-30", resourceId: "R001"},
                    {posId: "POS002", position: "Backend Developer", resourceLevel: "Senior", capacity: 100, expectedStart: "2025-01-15", expectedEnd: "2025-06-30", resourceId: "R002"},
                    {posId: "POS003", position: "Full Stack Developer", resourceLevel: "Senior", capacity: 100, expectedStart: "2025-02-01", expectedEnd: "2025-06-30", resourceId: "R003"}
                ]},
                {id: "P002", name: "Analytics Dashboard", client: "DataDriven Inc", type: "Planned", probability: 75, priority: "Medium", startDate: "2025-03-01", endDate: "2025-07-31", requiredFTE: 2, positions: [
                    {posId: "POS004", position: "Frontend Developer", resourceLevel: "Mid", capacity: 100, expectedStart: "2025-03-01", expectedEnd: "2025-07-31", resourceId: ""},
                    {posId: "POS005", position: "Data Engineer", resourceLevel: "Senior", capacity: 100, expectedStart: "2025-03-01", expectedEnd: "2025-07-31", resourceId: ""}
                ]}
            ]
            // NOTE: allocations array removed - now automatically derived from project positions
        };

        let charts = {};
        let editingProjectId = null; // null = adding new, otherwise editing
        let expandedProjects = {};   // track which project rows are expanded
        let posIdCounter = 100;

        // ========== INITIALIZE ==========
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved data if exists
            const saved = localStorage.getItem('erpPlanningData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Migrate old data: add skills/resourceLevels/positions if missing
                    if (!parsed.skills) parsed.skills = data.skills;
                    if (!parsed.resourceLevels) parsed.resourceLevels = data.resourceLevels;
                    if (parsed.resources) {
                        parsed.resources.forEach(r => {
                            if (!r.resourceLevel) r.resourceLevel = 'Mid';
                        });
                    }
                    if (parsed.projects) {
                        parsed.projects.forEach(p => {
                            if (!p.positions) {
                                p.positions = [];
                                const count = Math.max(1, Math.round(p.requiredFTE || 1));
                                for (let i = 0; i < count; i++) {
                                    p.positions.push({
                                        posId: 'POS' + (++posIdCounter).toString().padStart(3,'0'),
                                        position: 'Position ' + (i+1),
                                        resourceLevel: 'Mid',
                                        capacity: 100,
                                        expectedStart: p.startDate || '',
                                        expectedEnd: p.endDate || '',
                                        resourceId: ''
                                    });
                                }
                            }
                        });
                    }
                    data = parsed;
                } catch(e) {}
            }

            // Setup tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });

            renderResources();
            renderProjects();
        });

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');

            if (tabName === 'dashboard') {
                populateDashFilters();
                renderDashboard();
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        function genId(prefix) {
            const arr = prefix === 'R' ? data.resources : prefix === 'P' ? data.projects : [];
            const nums = arr.map(x => parseInt(x.id.replace(prefix, '')) || 0);
            return prefix + (Math.max(0, ...nums) + 1).toString().padStart(3, '0');
        }

        function genPosId() {
            posIdCounter++;
            // Also scan existing
            data.projects.forEach(p => {
                (p.positions || []).forEach(pos => {
                    const n = parseInt(pos.posId.replace('POS','')) || 0;
                    if (n >= posIdCounter) posIdCounter = n + 1;
                });
            });
            return 'POS' + posIdCounter.toString().padStart(3,'0');
        }

        function saveToLocal() {
            localStorage.setItem('erpPlanningData', JSON.stringify(data));
        }

        // ========== MODAL HELPERS ==========
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ========== SKILLS MANAGEMENT ==========
        function openManageSkillsModal() {
            renderSkillTags();
            openModal('manageSkillsOverlay');
        }

        function renderSkillTags() {
            const container = document.getElementById('skillTagList');
            container.innerHTML = data.skills.map((s, i) => `
                <span class="tag-item">
                    ${s}
                    <button class="tag-remove" onclick="removeSkill(${i})" title="Remove">&times;</button>
                </span>
            `).join('');
        }

        function addSkillTag() {
            const input = document.getElementById('newSkillInput');
            const val = input.value.trim();
            if (!val) return;
            if (data.skills.includes(val)) {
                showToast('Skill already exists');
                return;
            }
            data.skills.push(val);
            input.value = '';
            renderSkillTags();
            saveToLocal();
            renderResources();
            showToast('Skill "' + val + '" added');
        }

        function removeSkill(index) {
            const skill = data.skills[index];
            // Check if skill is in use
            const inUse = data.resources.some(r => r.primarySkill === skill || r.secondarySkill === skill);
            if (inUse) {
                if (!confirm(`Skill "${skill}" is assigned to resources. Remove anyway? Resources will keep their current values.`)) return;
            }
            data.skills.splice(index, 1);
            renderSkillTags();
            saveToLocal();
            renderResources();
            showToast('Skill "' + skill + '" removed');
        }

        // ========== RESOURCE LEVELS MANAGEMENT ==========
        function openManageLevelsModal() {
            renderLevelTags();
            openModal('manageLevelsOverlay');
        }

        function renderLevelTags() {
            const container = document.getElementById('levelTagList');
            container.innerHTML = data.resourceLevels.map((l, i) => `
                <span class="tag-item">
                    ${l}
                    <button class="tag-remove" onclick="removeLevel(${i})" title="Remove">&times;</button>
                </span>
            `).join('');
        }

        function addLevelTag() {
            const input = document.getElementById('newLevelInput');
            const val = input.value.trim();
            if (!val) return;
            if (data.resourceLevels.includes(val)) {
                showToast('Level already exists');
                return;
            }
            data.resourceLevels.push(val);
            input.value = '';
            renderLevelTags();
            saveToLocal();
            renderResources();
            showToast('Level "' + val + '" added');
        }

        function removeLevel(index) {
            const level = data.resourceLevels[index];
            const inUse = data.resources.some(r => r.resourceLevel === level);
            if (inUse) {
                if (!confirm(`Level "${level}" is assigned to resources. Remove anyway?`)) return;
            }
            data.resourceLevels.splice(index, 1);
            renderLevelTags();
            saveToLocal();
            renderResources();
            showToast('Level "' + level + '" removed');
        }

        // ========== RESOURCES ==========
        function renderResources() {
            const tbody = document.getElementById('resourcesBody');
            if (data.resources.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üë•</div><h3>No resources yet</h3><p>Add your first team member</p></td></tr>';
                return;
            }

            tbody.innerHTML = data.resources.map(r => `
                <tr>
                    <td><input type="text" value="${esc(r.name)}" onchange="updateResource('${r.id}','name',this.value)"></td>
                    <td><select onchange="updateResource('${r.id}','primarySkill',this.value)">${skillOpts(r.primarySkill)}</select></td>
                    <td><select onchange="updateResource('${r.id}','secondarySkill',this.value)"><option value="">None</option>${skillOpts(r.secondarySkill)}</select></td>
                    <td><select onchange="updateResource('${r.id}','resourceLevel',this.value)">${levelOpts(r.resourceLevel)}</select></td>
                    <td><select onchange="updateResource('${r.id}','status',this.value)">
                        <option value="Active" ${r.status==='Active'?'selected':''}>Active</option>
                        <option value="Bench" ${r.status==='Bench'?'selected':''}>Bench</option>
                        <option value="Leave" ${r.status==='Leave'?'selected':''}>Leave</option>
                    </select></td>
                    <td><input type="number" value="${r.hoursPerWeek}" onchange="updateResource('${r.id}','hoursPerWeek',+this.value)"></td>
                    <td><input type="number" value="${r.costRate}" onchange="updateResource('${r.id}','costRate',+this.value)"></td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteResource('${r.id}')">√ó</button></td>
                </tr>
            `).join('');
        }

        function esc(str) {
            return String(str).replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function skillOpts(sel) {
            return data.skills.map(s => `<option value="${s}" ${s===sel?'selected':''}>${s}</option>`).join('');
        }

        function levelOpts(sel) {
            return data.resourceLevels.map(l => `<option value="${l}" ${l===sel?'selected':''}>${l}</option>`).join('');
        }

        function addResource() {
            data.resources.push({
                id: genId('R'),
                name: 'New Resource',
                primarySkill: data.skills[0] || '',
                secondarySkill: '',
                resourceLevel: data.resourceLevels[0] || '',
                status: 'Active',
                hoursPerWeek: 40,
                costRate: 100
            });
            renderResources();
            saveToLocal();
            showToast('Resource added');
        }

        function updateResource(id, field, val) {
            const r = data.resources.find(x => x.id === id);
            if (r) { r[field] = val; saveToLocal(); }
        }

        function deleteResource(id) {
            if (confirm('Delete this resource?')) {
                data.resources = data.resources.filter(x => x.id !== id);
                // Note: Allocations are now derived from project positions, no need to delete separately
                renderResources();
                saveToLocal();
                showToast('Resource deleted');
            }
        }

        // ========== PROJECTS ==========
        function renderProjects() {
            const tbody = document.getElementById('projectsBody');
            if (data.projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">üìÅ</div><h3>No projects yet</h3><p>Add your first project</p></td></tr>';
                return;
            }

            let html = '';
            data.projects.forEach(p => {
                const isExpanded = expandedProjects[p.id];
                html += `
                <tr>
                    <td><button class="btn-expand" onclick="toggleProjectPositions('${p.id}')" title="Show/hide positions">${isExpanded ? '‚ñº' : '‚ñ∂'}</button></td>
                    <td><input type="text" value="${esc(p.name)}" onchange="updateProject('${p.id}','name',this.value)" style="min-width:140px"></td>
                    <td><input type="text" value="${esc(p.client)}" onchange="updateProject('${p.id}','client',this.value)"></td>
                    <td><select onchange="updateProject('${p.id}','type',this.value)">
                        <option value="Active" ${p.type==='Active'?'selected':''}>Active</option>
                        <option value="Planned" ${p.type==='Planned'?'selected':''}>Planned</option>
                    </select></td>
                    <td><input type="number" value="${p.probability}" min="0" max="100" onchange="updateProject('${p.id}','probability',+this.value)"></td>
                    <td><select onchange="updateProject('${p.id}','priority',this.value)">
                        <option value="High" ${p.priority==='High'?'selected':''}>High</option>
                        <option value="Medium" ${p.priority==='Medium'?'selected':''}>Medium</option>
                        <option value="Low" ${p.priority==='Low'?'selected':''}>Low</option>
                    </select></td>
                    <td><input type="date" value="${p.startDate}" onchange="updateProject('${p.id}','startDate',this.value)"></td>
                    <td><input type="date" value="${p.endDate}" onchange="updateProject('${p.id}','endDate',this.value)"></td>
                    <td><input type="number" value="${p.requiredFTE}" step="1" min="1" onchange="updateProjectFTE('${p.id}',+this.value)"></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="openEditProjectModal('${p.id}')" title="Edit positions">‚úé</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProject('${p.id}')">√ó</button>
                    </td>
                </tr>`;

                // Expandable positions row
                if (isExpanded && p.positions && p.positions.length) {
                    html += `<tr class="project-positions-row"><td colspan="10"><div class="project-positions-inner">
                        <h5>Positions (${p.positions.length})</h5>
                        <table class="pos-mini-table">
                            <thead><tr>
                                <th>#</th><th>Position</th><th>Resource Level</th><th>% Capacity</th>
                                <th>Expected Start</th><th>Expected End</th><th>Resource Allocation</th>
                            </tr></thead>
                            <tbody>${p.positions.map((pos, idx) => `
                                <tr>
                                    <td>${idx + 1}</td>
                                    <td><input type="text" value="${esc(pos.position)}" onchange="updatePosition('${p.id}','${pos.posId}','position',this.value)"></td>
                                    <td><select onchange="updatePosition('${p.id}','${pos.posId}','resourceLevel',this.value)">${levelOpts(pos.resourceLevel)}</select></td>
                                    <td><input type="number" value="${pos.capacity}" min="0" max="100" onchange="updatePosition('${p.id}','${pos.posId}','capacity',+this.value)"></td>
                                    <td><input type="date" value="${pos.expectedStart}" onchange="updatePosition('${p.id}','${pos.posId}','expectedStart',this.value)"></td>
                                    <td><input type="date" value="${pos.expectedEnd}" onchange="updatePosition('${p.id}','${pos.posId}','expectedEnd',this.value)"></td>
                                    <td><select onchange="updatePosition('${p.id}','${pos.posId}','resourceId',this.value)">
                                        <option value="">-- Unassigned --</option>
                                        ${data.resources.map(r => `<option value="${r.id}" ${r.id===pos.resourceId?'selected':''}>${r.name}</option>`).join('')}
                                    </select></td>
                                </tr>
                            `).join('')}</tbody>
                        </table>
                    </div></td></tr>`;
                }
            });

            tbody.innerHTML = html;
        }

        function toggleProjectPositions(projectId) {
            expandedProjects[projectId] = !expandedProjects[projectId];
            renderProjects();
        }

        function updatePosition(projectId, posId, field, val) {
            const p = data.projects.find(x => x.id === projectId);
            if (!p || !p.positions) return;
            const pos = p.positions.find(x => x.posId === posId);
            if (pos) { pos[field] = val; saveToLocal(); }
        }

        function updateProjectFTE(projectId, newFTE) {
            const p = data.projects.find(x => x.id === projectId);
            if (!p) return;
            newFTE = Math.max(1, Math.round(newFTE));
            p.requiredFTE = newFTE;

            if (!p.positions) p.positions = [];

            // Add positions if needed
            while (p.positions.length < newFTE) {
                p.positions.push({
                    posId: genPosId(),
                    position: 'Position ' + (p.positions.length + 1),
                    resourceLevel: data.resourceLevels[0] || '',
                    capacity: 100,
                    expectedStart: p.startDate || '',
                    expectedEnd: p.endDate || '',
                    resourceId: ''
                });
            }
            // Remove positions from the end if needed
            while (p.positions.length > newFTE) {
                p.positions.pop();
            }

            saveToLocal();
            renderProjects();
        }

        // ===== ADD PROJECT MODAL =====
        function openAddProjectModal() {
            editingProjectId = null;
            document.getElementById('projectModalTitle').textContent = 'Add Project';
            document.getElementById('projectModalSaveBtn').textContent = 'Save Project';

            const today = new Date().toISOString().split('T')[0];
            const end = new Date();
            end.setMonth(end.getMonth() + 3);

            document.getElementById('pf_name').value = '';
            document.getElementById('pf_client').value = '';
            document.getElementById('pf_type').value = 'Planned';
            document.getElementById('pf_probability').value = 50;
            document.getElementById('pf_priority').value = 'Medium';
            document.getElementById('pf_startDate').value = today;
            document.getElementById('pf_endDate').value = end.toISOString().split('T')[0];
            document.getElementById('pf_requiredFTE').value = 1;

            updateProjectFormPositions();
            openModal('projectModalOverlay');
        }

        function openEditProjectModal(projectId) {
            const p = data.projects.find(x => x.id === projectId);
            if (!p) return;

            editingProjectId = projectId;
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('projectModalSaveBtn').textContent = 'Update Project';

            document.getElementById('pf_name').value = p.name;
            document.getElementById('pf_client').value = p.client;
            document.getElementById('pf_type').value = p.type;
            document.getElementById('pf_probability').value = p.probability;
            document.getElementById('pf_priority').value = p.priority;
            document.getElementById('pf_startDate').value = p.startDate;
            document.getElementById('pf_endDate').value = p.endDate;
            document.getElementById('pf_requiredFTE').value = p.requiredFTE;

            updateProjectFormPositions(p.positions);
            openModal('projectModalOverlay');
        }

        function updateProjectFormPositions(existingPositions) {
            const fte = Math.max(1, Math.round(+document.getElementById('pf_requiredFTE').value || 1));
            const startDate = document.getElementById('pf_startDate').value;
            const endDate = document.getElementById('pf_endDate').value;
            const tbody = document.getElementById('projectFormPositionsBody');

            let positions = existingPositions || [];

            // Adjust count
            while (positions.length < fte) {
                positions.push({
                    posId: genPosId(),
                    position: '',
                    resourceLevel: data.resourceLevels[0] || '',
                    capacity: 100,
                    expectedStart: startDate,
                    expectedEnd: endDate,
                    resourceId: ''
                });
            }
            while (positions.length > fte) {
                positions.pop();
            }

            // Store reference for saving
            window._tempPositions = positions;

            tbody.innerHTML = positions.map((pos, idx) => `
                <tr>
                    <td>${idx + 1}</td>
                    <td><input type="text" value="${esc(pos.position)}" placeholder="e.g. Lead Developer" onchange="window._tempPositions[${idx}].position=this.value"></td>
                    <td><select onchange="window._tempPositions[${idx}].resourceLevel=this.value">${levelOpts(pos.resourceLevel)}</select></td>
                    <td><input type="number" value="${pos.capacity}" min="0" max="100" onchange="window._tempPositions[${idx}].capacity=+this.value"></td>
                    <td><input type="date" value="${pos.expectedStart}" onchange="window._tempPositions[${idx}].expectedStart=this.value"></td>
                    <td><input type="date" value="${pos.expectedEnd}" onchange="window._tempPositions[${idx}].expectedEnd=this.value"></td>
                    <td><select onchange="window._tempPositions[${idx}].resourceId=this.value">
                        <option value="">-- Unassigned --</option>
                        ${data.resources.map(r => `<option value="${r.id}" ${r.id===pos.resourceId?'selected':''}>${r.name}</option>`).join('')}
                    </select></td>
                </tr>
            `).join('');
        }

        function saveProjectFromModal() {
            const name = document.getElementById('pf_name').value.trim();
            const client = document.getElementById('pf_client').value.trim();
            const type = document.getElementById('pf_type').value;
            const probability = +document.getElementById('pf_probability').value;
            const priority = document.getElementById('pf_priority').value;
            const startDate = document.getElementById('pf_startDate').value;
            const endDate = document.getElementById('pf_endDate').value;
            const requiredFTE = Math.max(1, Math.round(+document.getElementById('pf_requiredFTE').value || 1));

            if (!name) {
                showToast('Please enter a project name');
                return;
            }
            if (!startDate || !endDate) {
                showToast('Please enter start and end dates');
                return;
            }

            const positions = (window._tempPositions || []).map(pos => ({...pos}));

            if (editingProjectId) {
                // Update existing
                const p = data.projects.find(x => x.id === editingProjectId);
                if (p) {
                    p.name = name;
                    p.client = client;
                    p.type = type;
                    p.probability = probability;
                    p.priority = priority;
                    p.startDate = startDate;
                    p.endDate = endDate;
                    p.requiredFTE = requiredFTE;
                    p.positions = positions;
                }
                showToast('Project updated');
            } else {
                // Add new
                data.projects.push({
                    id: genId('P'),
                    name, client, type, probability, priority,
                    startDate, endDate, requiredFTE,
                    positions
                });
                showToast('Project added');
            }

            saveToLocal();
            renderProjects();
            closeModal('projectModalOverlay');
            window._tempPositions = null;
        }

        function updateProject(id, field, val) {
            const p = data.projects.find(x => x.id === id);
            if (p) { p[field] = val; saveToLocal(); }
        }

        function deleteProject(id) {
            if (confirm('Delete this project?')) {
                data.projects = data.projects.filter(x => x.id !== id);
                // Note: Allocations are now derived from project positions, no need to delete separately
                delete expandedProjects[id];
                renderProjects();
                saveToLocal();
                showToast('Project deleted');
            }
        }

        // ========== ALLOCATIONS (REMOVED - NOW DERIVED FROM PROJECT POSITIONS) ==========
        // Allocation data is now automatically derived from project positions in getDerivedAllocations()
        // This allows managing allocations directly within the Projects tab

        // ========== DASHBOARD ==========
        function populateDashFilters() {
            const skills = [...new Set(data.resources.map(r => r.primarySkill))];
            document.getElementById('dashFilterSkill').innerHTML = '<option value="">All Skills</option>' +
                skills.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function resetDashFilters() {
            document.getElementById('dashFilterSkill').value = '';
            document.getElementById('dashFilterType').value = '';
            renderDashboard();
        }

        // ========== DERIVE ALLOCATIONS FROM PROJECT POSITIONS ==========
        function getDerivedAllocations() {
            const allocations = [];
            let allocIdCounter = 1;

            data.projects.forEach(project => {
                if (!project.positions) return;

                project.positions.forEach(position => {
                    if (!position.resourceId || !position.expectedStart || !position.expectedEnd) return;

                    const resource = data.resources.find(r => r.id === position.resourceId);
                    if (!resource) return;

                    // Generate month list from expectedStart to expectedEnd
                    const months = getMonthsBetween(position.expectedStart, position.expectedEnd);

                    months.forEach(month => {
                        allocations.push({
                            id: "A" + String(allocIdCounter++).padStart(3, '0'),
                            resourceId: position.resourceId,
                            projectId: project.id,
                            month: month,
                            percent: position.capacity || 100,
                            role: position.position || ''
                        });
                    });
                });
            });

            return allocations;
        }

        function getMonthsBetween(startDate, endDate) {
            if (!startDate || !endDate) return [];

            const months = [];
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

            const start = new Date(startDate);
            const end = new Date(endDate);

            // Set to first day of month to avoid date calculation issues
            start.setDate(1);
            end.setDate(1);

            const current = new Date(start);

            while (current <= end) {
                const monthName = monthNames[current.getMonth()];
                const year = current.getFullYear();
                months.push(`${monthName}-${year}`);

                current.setMonth(current.getMonth() + 1);
            }

            return months;
        }

        function getFilteredData() {
            const sf = document.getElementById('dashFilterSkill')?.value || '';
            const tf = document.getElementById('dashFilterType')?.value || '';

            let resources = data.resources;
            let projects = data.projects;

            if (sf) resources = resources.filter(r => r.primarySkill === sf);
            if (tf) projects = projects.filter(p => p.type === tf);

            const rids = resources.map(r => r.id);
            const pids = projects.map(p => p.id);

            // Use derived allocations from project positions
            const allAllocations = getDerivedAllocations();
            const allocations = allAllocations.filter(a => rids.includes(a.resourceId) && pids.includes(a.projectId));

            return {resources, projects, allocations};
        }

        function renderDashboard() {
            const fd = getFilteredData();
            updateMetrics(fd);
            renderPipelineChart(fd);
            renderUtilizationChart(fd);
            renderRevenueChart(fd);
            renderSupplyDemandChart(fd);
            renderHeatmap(fd);
        }

        function updateMetrics(fd) {
            const active = fd.projects.filter(p => p.type === 'Active');
            const planned = fd.projects.filter(p => p.type === 'Planned');

            document.getElementById('metricActiveProjects').textContent = active.length;
            document.getElementById('metricPlannedProjects').textContent = planned.length;
            document.getElementById('metricWeightedFTE').textContent = planned.reduce((s,p) => s + p.requiredFTE * p.probability/100, 0).toFixed(1) + ' weighted FTE';
            document.getElementById('metricResources').textContent = fd.resources.length;

            const util = {};
            fd.resources.forEach(r => util[r.id] = []);
            fd.allocations.forEach(a => { if(util[a.resourceId]) util[a.resourceId].push(a.percent); });

            let totalUtil = 0, count = 0, available = 0, overloaded = 0;
            Object.values(util).forEach(arr => {
                if (arr.length) {
                    const avg = arr.reduce((a,b)=>a+b,0)/arr.length;
                    totalUtil += avg; count++;
                    if (avg < 50) available++;
                    if (arr.some(p => p > 100)) overloaded++;
                } else { available++; }
            });

            document.getElementById('metricAvgUtil').textContent = (count ? Math.round(totalUtil/count) : 0) + '% avg util';
            document.getElementById('metricAvailable').textContent = available;
            document.getElementById('metricOverloaded').textContent = overloaded;
        }

        function renderPipelineChart(fd) {
            const ctx = document.getElementById('pipelineChart').getContext('2d');
            if (charts.pipeline) charts.pipeline.destroy();

            const sorted = [...fd.projects].sort((a,b) => a.type !== b.type ? (a.type === 'Active' ? -1 : 1) : b.probability - a.probability);

            charts.pipeline = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(p => p.name.substring(0,18)),
                    datasets: [{
                        label: 'Required FTE',
                        data: sorted.map(p => p.requiredFTE),
                        backgroundColor: sorted.map(p => p.type === 'Active' ? '#059669' : '#0ea5e9'),
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {display: false}},
                    scales: {
                        x: {beginAtZero: true, grid: {color: '#e2e8f0'}, ticks: {color: '#64748b'}},
                        y: {grid: {display: false}, ticks: {color: '#475569', font: {size: 10}}}
                    }
                }
            });
        }

        function renderUtilizationChart(fd) {
            const ctx = document.getElementById('utilizationChart').getContext('2d');
            if (charts.utilization) charts.utilization.destroy();

            const months = sortMonths([...new Set(fd.allocations.map(a => a.month))]);
            const cap = fd.resources.length * 100;
            const utilByMonth = {};
            months.forEach(m => utilByMonth[m] = 0);

            fd.allocations.forEach(a => {
                const p = data.projects.find(x => x.id === a.projectId);
                utilByMonth[a.month] = (utilByMonth[a.month]||0) + a.percent * (p ? p.probability/100 : 1);
            });

            charts.utilization = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {label: 'Target', data: months.map(() => 100), borderColor: '#94a3b8', borderDash: [5,5], pointRadius: 0, borderWidth: 2},
                        {label: 'Utilization %', data: months.map(m => cap ? Math.round(utilByMonth[m]/cap*100) : 0), borderColor: '#4f46e5', backgroundColor: 'rgba(79,70,229,0.1)', fill: true, tension: 0.3, pointRadius: 4}
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {legend: {position: 'bottom', labels: {usePointStyle: true, font: {size: 10}}}},
                    scales: {
                        y: {beginAtZero: true, max: 120, grid: {color: '#e2e8f0'}, ticks: {color: '#64748b', callback: v => v+'%'}},
                        x: {grid: {display: false}, ticks: {color: '#64748b', font: {size: 10}}}
                    }
                }
            });
        }

        function renderRevenueChart(fd) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (charts.revenue) charts.revenue.destroy();

            const months = sortMonths([...new Set(fd.allocations.map(a => a.month))]);
            const rev = {};
            months.forEach(m => rev[m] = 0);

            fd.allocations.forEach(a => {
                const r = data.resources.find(x => x.id === a.resourceId);
                const p = data.projects.find(x => x.id === a.projectId);
                if (r && p) rev[a.month] = (rev[a.month]||0) + r.costRate * (a.percent/100) * r.hoursPerWeek * 4.33 * (p.probability/100);
            });

            charts.revenue = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{label: 'Revenue ($K)', data: months.map(m => Math.round(rev[m]/1000)), backgroundColor: '#10b981', borderRadius: 4}]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {legend: {display: false}},
                    scales: {
                        y: {beginAtZero: true, grid: {color: '#e2e8f0'}, ticks: {color: '#64748b', callback: v => '$'+v+'K'}},
                        x: {grid: {display: false}, ticks: {color: '#64748b', font: {size: 10}}}
                    }
                }
            });
        }

        function renderSupplyDemandChart(fd) {
            const ctx = document.getElementById('supplyDemandChart').getContext('2d');
            if (charts.supplyDemand) charts.supplyDemand.destroy();

            const supply = {}, demand = {};
            fd.resources.forEach(r => supply[r.primarySkill] = (supply[r.primarySkill]||0) + 1);

            const mc = [...new Set(fd.allocations.map(a => a.month))].length || 1;
            fd.allocations.forEach(a => {
                const r = data.resources.find(x => x.id === a.resourceId);
                const p = data.projects.find(x => x.id === a.projectId);
                if (r && p) demand[r.primarySkill] = (demand[r.primarySkill]||0) + (a.percent/100) * (p.probability/100);
            });
            Object.keys(demand).forEach(s => demand[s] /= mc);

            const skills = [...new Set([...Object.keys(supply), ...Object.keys(demand)])];

            charts.supplyDemand = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: skills,
                    datasets: [
                        {label: 'Supply', data: skills.map(s => supply[s]||0), backgroundColor: '#10b981', borderRadius: 4},
                        {label: 'Demand', data: skills.map(s => (demand[s]||0).toFixed(1)), backgroundColor: '#6366f1', borderRadius: 4}
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {legend: {position: 'bottom', labels: {usePointStyle: true, font: {size: 10}}}},
                    scales: {
                        y: {beginAtZero: true, grid: {color: '#e2e8f0'}, ticks: {color: '#64748b'}},
                        x: {grid: {display: false}, ticks: {color: '#64748b', font: {size: 10}}}
                    }
                }
            });
        }

        function renderHeatmap(fd) {
            const table = document.getElementById('heatmapTable');
            // Use derived allocations instead of data.allocations
            const allAllocations = getDerivedAllocations();
            const months = sortMonths([...new Set(allAllocations.map(a => a.month))]);

            if (!months.length || !fd.resources.length) {
                table.innerHTML = '<tr><td class="empty-state">No data</td></tr>';
                return;
            }

            const util = {};
            fd.resources.forEach(r => {
                util[r.id] = {};
                months.forEach(m => util[r.id][m] = 0);
            });
            fd.allocations.forEach(a => { if(util[a.resourceId]) util[a.resourceId][a.month] = (util[a.resourceId][a.month]||0) + a.percent; });

            table.querySelector('thead').innerHTML = `<tr><th>Resource</th>${months.map(m => `<th>${m}</th>`).join('')}<th>Avg</th></tr>`;

            table.querySelector('tbody').innerHTML = fd.resources.map(r => {
                const vals = months.map(m => util[r.id][m]||0);
                const nz = vals.filter(v => v > 0);
                const avg = nz.length ? Math.round(nz.reduce((a,b)=>a+b,0)/nz.length) : 0;
                return `<tr><td>${esc(r.name)}</td>${months.map(m => {
                    const v = util[r.id][m]||0;
                    return `<td><div class="heatmap-cell ${heatClass(v)}">${v}%</div></td>`;
                }).join('')}<td><div class="heatmap-cell ${heatClass(avg)}">${avg}%</div></td></tr>`;
            }).join('');
        }

        function heatClass(v) {
            if (v === 0) return 'heatmap-available';
            if (v > 100) return 'heatmap-overload';
            if (v >= 90) return 'heatmap-high';
            if (v >= 70) return 'heatmap-optimal';
            if (v >= 50) return 'heatmap-medium';
            return 'heatmap-low';
        }

        function sortMonths(months) {
            const order = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return months.sort((a,b) => {
                const [ma,ya] = a.split('-');
                const [mb,yb] = b.split('-');
                return ya !== yb ? parseInt(ya) - parseInt(yb) : order.indexOf(ma) - order.indexOf(mb);
            });
        }

        // ========== PDF EXPORT ==========
        async function exportPDF() {
            showToast('Generating PDF...');

            const content = document.getElementById('dashboardContent');
            const { jsPDF } = window.jspdf;

            try {
                const canvas = await html2canvas(content, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#f8fafc'
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('l', 'mm', 'a4');

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const imgX = (pdfWidth - imgWidth * ratio) / 2;
                const imgY = 10;

                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                pdf.save('ERP_Resource_Planning_Dashboard.pdf');

                showToast('PDF downloaded!');
            } catch (err) {
                console.error(err);
                showToast('Error generating PDF');
            }
        }

        // ========== SAVE & IMPORT ==========
        function saveFile() {
            const blob = new Blob([document.documentElement.outerHTML.replace(
                /localStorage\.getItem\('erpPlanningData'\)/g,
                `'${JSON.stringify(data).replace(/\\/g, '\\\\').replace(/'/g, "\\'")}'`
            )], {type: 'text/html'});

            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ERP_Resource_Planning.html';
            a.click();
            URL.revokeObjectURL(a.href);

            showToast('File saved!');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const text = await file.text();
                        const imported = JSON.parse(text);
                        if (imported.resources && imported.projects) {
                            if (!imported.skills) imported.skills = data.skills;
                            if (!imported.resourceLevels) imported.resourceLevels = data.resourceLevels;
                            imported.resources.forEach(r => { if (!r.resourceLevel) r.resourceLevel = 'Mid'; });
                            imported.projects.forEach(p => { if (!p.positions) p.positions = []; });
                            // Remove old allocations if present (now derived from project positions)
                            delete imported.allocations;
                            data = imported;
                            saveToLocal();
                            renderResources();
                            renderProjects();
                            showToast('Data imported!');
                        } else {
                            showToast('Invalid format');
                        }
                    } catch (e) {
                        showToast('Error reading file');
                    }
                }
            };
            input.click();
        }
    </script>


</body></html>
